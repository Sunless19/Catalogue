<div class="teacher-wrapper">
  <div class="teacher-header">
    <h2>📚 My Classes</h2>
    <div *ngIf="isLoadingClasses">Loading classes...</div>
    <div *ngIf="isLoadingGrades && !isLoadingClasses">Loading grades...</div>
    <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>
  </div>

  <div class="class-list-wrapper" *ngIf="!isLoadingClasses && classes.length > 0">
    <div *ngFor="let class of classes; let i = index" class="class-card" (click)="toggleClass(i, $event)">
      <div class="class-header">
        <h3>{{ class.name }}</h3>
        <button *ngIf="!class.showInput" (click)="showInputField(i, $event)">➕</button>
      </div>

      <div *ngIf="class.showInput" class="add-student-input" (click)="$event.stopPropagation()">
        <input
          type="text"
          [(ngModel)]="class.newStudentName"
          placeholder="New student name"
          (keyup.enter)="addStudent(i, $event)"
        />
        <button (click)="addStudent(i, $event)">Add</button>
        <button (click)="class.showInput = false">Cancel</button>
      </div>

      <div *ngIf="class.expanded" class="students-container">
        <div *ngIf="class.students.length === 0" class="no-students">No students in this class yet.</div>

        
        <div *ngFor="let student of class.students" class="student-card">
          <div class="student-header">
            <h4>{{ student.name }}</h4>
            <input
            type="checkbox"
            [checked]="selectedStudentIds.has(student.studentId)"
            (change)="toggleStudentSelection(student.studentId)"
          />
          </div>

          <ul class="grades-list">
            <li *ngFor="let grade of student.grades" class="grade-item">
              <ng-container *ngIf="!grade.isEditing">
                <input
                type="checkbox"
                [checked]="selectedGrades.has(grade.id)"
                (click)="toggleGradeSelection(grade.id); $event.stopPropagation()"
                class="grade-checkbox"
              />
        
                <span>
                  {{ grade.assignmentName ? grade.assignmentName + ': ' : '' }}
                  <strong>{{ grade.value || 'N/A' }}</strong>
                  <span class="grade-date" *ngIf="grade.date">
                    ({{ grade.date | date:'shortDate' }})
                  </span>
                </span>
                <div class="grade-actions">
                  <button (click)="startEditGrade(grade); $event.stopPropagation()">✏️</button>
                  <button (click)="deleteGrade(grade, student); $event.stopPropagation()">🗑️</button>
                </div>
              </ng-container>

              <ng-container *ngIf="grade.isEditing">
                <div class="edit-grade-form" (click)="$event.stopPropagation()">
                  <input type="text" [(ngModel)]="grade.editValue" placeholder="Grade value" />
                  <input type="date" [(ngModel)]="grade.editDate" />
                  <button (click)="saveEditGrade(grade)">💾 Save</button>
                  <button (click)="cancelEditGrade(grade)">❌ Cancel</button>
                </div>
              </ng-container>
            </li>
          </ul>

          <div *ngIf="student.grades.length === 0 && !isLoadingGrades" class="no-grades">
            No grades recorded yet.
          </div>

          <div class="add-grade-form">
            <input
              type="text"
              [(ngModel)]="newGradeValues[student.studentId]"
              placeholder="Enter grade"
              [ngClass]="{'invalid-input': isGradeInvalid(newGradeValues[student.studentId])}"
            />
            <button
              class="btn-primary"
              (click)="addGrade(student.studentId, class.classId)"
              [disabled]="isGradeInvalid(newGradeValues[student.studentId])"
            >
              ➕ Submit
            </button>
          </div>
        </div>

        <div *ngIf="isAnyGradeSelected()" class="bulk-actions">
          <button class="btn-delete" (click)="bulkDelete()">🗑️ Bulk Delete</button>
          <button class="btn-edit" (click)="bulkEdit()">✏️ Bulk Edit</button>
        </div>
        
        <div *ngIf="isAnyStudentSelected()" class="bulk-selected-grade-card">
          <h4>📝 Bulk Add Grade to Selected</h4>
          <input
            type="text"
            [(ngModel)]="selectedBulkGradeValue"
            placeholder="Enter grade for selected students"
            [ngClass]="{'invalid-input': isGradeInvalid(selectedBulkGradeValue)}"
          />
          <button
            class="btn-primary"
            (click)="bulkAddToSelected()"
            [disabled]="isGradeInvalid(selectedBulkGradeValue)"
          >
            ➕ Apply Grade
          </button>
        </div>
        
        
      </div>
    </div>
  </div>

  <div *ngIf="!isLoadingClasses && classes.length === 0 && !errorMessage" class="no-classes">
    You are not currently assigned to any classes.
  </div>
</div>
